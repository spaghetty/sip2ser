# Initial Version Copyright (C) 2010 eZuce, Inc., All Rights Reserved.
# Licensed to the User under the LGPL license.
# 

## Common make variables you may want to override in another makefile
SPLASH_FILE = /home/admin/sipxecs/sip2ser/mak/splash.jpg
ISO_LABEL ?= s2s_ISO
VOLUME_LABEL ?= "s2s @PACKAGE_VERSION@"
APPLICATION_LABEL ?= "s2s @PACKAGE_VERSION@"
PUBLISHER_ID ?= luciano.berardi@sip2ser.it
PREPARERER_ID ?= luciano.berardi@sip2ser.it
#ISO_SRC ?= /home/admin/sipxecs/sip2ser/mak/centos-iso


# default target, build both 32 and 64 bit cds
#help.iso = Build 32 and 64 versions of ISO from base CentOS ISO found in @ISO_DIR@
#iso: iso-32 iso-64;

#help.iso-clean = Delete intermediate files, but do not re-download RPMs from $(ISO_RPM_DOWNLOAD_URL)
#iso-clean: iso-clean-32 iso-clean-64
#	find @DIST_DIR@ -maxdepth 1 \( -name '*.iso' -o -name '*.md5' \) -exec rm {} \;
#	! test -f comps-iso.xml || rm comps-iso.xml

#help.iso-clean-all = Delete intermediate files, including files from downloaded from $(ISO_RPM_DOWNLOAD_URL) that will be downloaded again
#iso-clean-all: iso-clean-32 iso-clean-download-32 iso-clean-64 iso-clean-download-64;

# $(foreach B,32 64,$(eval help.iso-$(B) = Build sipXecs $(B)-bit only ISO from base CentOS ISO found in @ISO_DIR@))
s2s-iso-% : iso-% \
	s2s-iso-disc-%;
#\
#	iso-s2s-packages-% \
#	iso-update-repo-% \
#	iso-s2s-update-files-% \
#	iso-s2s-assemble-% \
#	iso-md5-%;


# need to make a copy of entire disc so we can modify
s2s-iso-disc-% :
	@echo "STICA" $(ISO)
	test -d cd || mkdir cd
	! test -d cd.tmp || rm -rf cd.tmp
	sudo mount -o loop $(wildcard @ISO_DIR@/$(ISO)) cd
	@echo "copying contents of disc..."
	cp -ar cd cd.tmp
	sudo umount cd
	chmod a+rw -R cd.tmp
	@echo "STICAZZI"$@
	mv cd.tmp s2s-iso

iso-s2s-packages-% : 
	rsync -av $(realpath @RPM_DIST_DIR@)/CentOS_6/$(ARCH)/ $(ISO_DISC)/Packages/

#iso-clean-download-% :
#	! test -d $(ISO_PACKAGES_OS) || rm -rf $(ISO_PACKAGES_OS)
#	! test -d $(ISO_PACKAGES_EPEL) || rm -rf $(ISO_PACKAGES_EPEL)

# force a rebuild of entire cd
#iso-clean-% :
#	! test -d $(ISO_DISC) || rm -rf $(ISO_DISC)
#	! test -f iso-download-os-$* || rm iso-download-os-$*
#	! test -f iso-download-epel-$* || rm iso-download-epel-$*

# copy sipxecs yum group defs into iso yum group defs
#comps-iso.xml : $(SRC)/mak/comps.xml $(SRC)/mak/centos-iso/comps.xsl
#	xsltproc $(SRC)/mak/centos-iso/comps.xsl $(SRC)/mak/comps.xml > $@.tmp
#	mv $@.tmp $@

# add modifications to disc to make it operate
iso-s2s-update-files-% :
	m4 $(ISO_M4_OPTS) $(ISO_SRC)/ks.m4 > $(ISO_DISC)/ks.cfg
	m4 $(ISO_M4_OPTS) -D manual-partition $(ISO_SRC)/ks.m4 > $(ISO_DISC)/ks-manual-format.cfg
	for f in $(ISOLINUX_FILES); do \
	  cp -f $$f $(ISO_DISC)/isolinux/`basename $$f`; \
	done

# assemble iso file
iso-s2s-assemble-% :
	chmod u+w $(ISO_DISC)/isolinux/isolinux.bin
	mkisofs -R -J -T -no-emul-boot -boot-load-size 4 -boot-info-table \
	  -V $(VOLUME_LABEL) \
	  -A $(APPLICATION_LABEL) \
	  -P $(PUBLISHER_ID) \
	  -p $(PREPARERER_ID) \
	  -b "isolinux/isolinux.bin" \
	  -c "isolinux/boot.cat" \
	  -x "lost+found" \
	  -o $@.tmp $(ISO_DISC)
	mv $@.tmp @DIST_DIR@/$(ISO)